<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="CMI625">
 
  <resultMap class="java.util.HashMap" id="AppApi30304Map">
    <result column="APPONUM" jdbcType="VARCHAR" property="apponum" />
  </resultMap>
  <resultMap class="java.util.HashMap" id="AppApi30305Map">
    <result column="APPONUM" jdbcType="VARCHAR" property="apponum" />
    <result column="APPOBRANCHNAME" jdbcType="VARCHAR" property="appobranchname" />
    <result column="APPODATE" jdbcType="VARCHAR" property="appodate" />
    <result column="TIMEINTERVAL" jdbcType="VARCHAR" property="timeinterval" />
    <result column="APPOBUSINAME" jdbcType="VARCHAR" property="appobusiname" />
    <result column="APPOID" jdbcType="VARCHAR" property="appoid" />
    <result column="FREEUSE2" jdbcType="VARCHAR" property="freeuse2" />
  </resultMap>
  <resultMap class="java.util.HashMap" id="SelectRemainPeople">
    <result column="APPOID" jdbcType="VARCHAR" property="appoid" />
    <result column="APPOBRANCHID" jdbcType="VARCHAR" property="appobranchid" />
    <result column="APPODATE" jdbcType="VARCHAR" property="appodate" />
  </resultMap>
 <select id="selectAppapi30304Bus" parameterClass="com.yondervision.mi.form.AppApi30304Form" resultMap="AppApi30304Map">
  select apponum from mi625 where personalid = #personalid:VARCHAR# AND CENTERID = #centerId:VARCHAR#
	and appobusiid = #appobusiid:VARCHAR#
	AND appostate ='01' 
	AND  validflag ='1'
	AND appodate>=#appodate:VARCHAR# 
	for update with RR use and keep exclusive locks
	<!-- oracle for update -->
  </select>
   <select id="selectAppapi30305User" parameterClass="com.yondervision.mi.form.AppApi30305Form" resultMap="AppApi30305Map">
  	select APPOID, APPONUM,APPOBRANCHNAME,APPODATE,TIMEINTERVAL,APPOBUSINAME,FREEUSE2 from MI625 
  	WHERE personalid = #personalid:VARCHAR# AND CENTERID = #centerId:VARCHAR#
  	AND appostate ='01'
  	AND  validflag ='1'
  	AND appodate>=#appodate:VARCHAR# 
  	order by APPOID asc
  </select>
  <select id="selectRemainPeople" parameterClass="com.yondervision.mi.form.AppApi30304Form" resultMap="SelectRemainPeople">
	<!--  select (select APPOCNT from ( 
        select sum(APPOCNT) as APPOCNT,APPOBRANCHID from mi624 where  
       	CENTERID= #centerId:VARCHAR# 
        and VALIDFLAG='1' 
        and APPOBRANCHID= #appobranchid:VARCHAR#   
        group by APPOBRANCHID) a 
        where a.APPOBRANCHID=b.APPOBRANCHID  fetch first 1 rows only)-count(*)  as apponum,
        appodate,APPOBRANCHID from mi625 b 
        where CENTERID= #centerId:VARCHAR# 
        and APPOSTATE='01'  
        and APPOBRANCHID= #appobranchid:VARCHAR# 
        and APPODATE= #appodate:VARCHAR# 
        group by appodate,APPOBRANCHID-->
        select APPOID,APPOBRANCHID,APPODATE from mi625 where  APPOBRANCHID=#appobranchid:VARCHAR# and centerid=#centerId:VARCHAR# and validflag='1' 
        	and appostate='01'
        	and APPODATE=#appodate:VARCHAR# 
        	and APPOTPLDETAILID= #appotpldetailid:VARCHAR#
        for update with RR use and keep exclusive locks
  </select>
   <select id="selectMi624SumAppocnt" parameterClass="com.yondervision.mi.form.AppApi30304Form" resultClass="java.lang.Integer" >
    select sum(appocnt) appocnt from MI624 where APPOBRANCHID=#appobranchid:VARCHAR# and CENTERID=#centerId:VARCHAR# and validflag='1'
    and APPOTPLDETAILID= #appotpldetailid:VARCHAR# 
  </select>
  <select id="countMi625ForMi607" parameterClass="com.yondervision.mi.dto.CMi607" resultClass="java.lang.Integer">
  	select count(*) from mi625 where personalid= #personalid:VARCHAR# and centerid=#centerid:VARCHAR#
	    and APPOSTATE='01' 
	    and VALIDFLAG='1' 
	    and <![CDATA[ APPODATE < #appodate:VARCHAR# ]]>
	    <isNotEmpty prepend="AND" property="begindate" >
           <![CDATA[ DATEMODIFIED >= #begindate:VARCHAR# ]]>
  		</isNotEmpty>
  		<isNotEmpty prepend="AND" property="enddate" >
  			<![CDATA[ DATEMODIFIED <= #enddate:VARCHAR# ]]>
  		</isNotEmpty>
  </select>
  <update id="updateAppostate" parameterClass="java.util.HashMap">
    <!--
      WARNING - This element is automatically generated by Abator for iBATIS, do not modify.
      This element was generated on Thu Sep 26 19:53:23 CST 2013.
    -->
    update MI625
         set APPOSTATE = #appostate:VARCHAR#,DATECANCELED=#datecanceled:VARCHAR#,COMPLETEDATE=#completedate:VARCHAR#,DATEMODIFIED=#datemodified:VARCHAR#
         where appoid in
     <iterate conjunction="," open="(" close=")" property="appoids">
            #appoids[]#
        </iterate> 
  </update>
   <select id="selectMi625All" parameterClass="com.yondervision.mi.dto.CMi625" resultClass="com.yondervision.mi.dto.CMi625">
  	select a.apponum apponum,a.appobranchname appobranchname,a.appodate appodate,a.timeinterval timeinterval,a.appobusiname 
	appobusiname,a.appostate appostate,a.userid userid,a.tel tel,a.channel channel,a.completedate completedate,a.datecanceled 
	datecanceled ,a.freeuse1 userid from mi625 a 
  		where a.validflag = '1'
  		 and a.CENTERID= #centerId:VARCHAR#
	    <isNotEmpty prepend="AND" property="appobusiid" >
           <![CDATA[ appobusiid = #appobusiid:VARCHAR# ]]>
  		</isNotEmpty>
  		<isNotEmpty prepend="AND" property="apponum" >
  			<![CDATA[ apponum = #apponum:VARCHAR# ]]>
  		</isNotEmpty>  
  		<isNotEmpty prepend="AND" property="appostate" >
           <![CDATA[ appostate = #appostate:VARCHAR# ]]>
  		</isNotEmpty>
  		<isNotEmpty prepend="AND" property="channel" >
  			<![CDATA[ channel = #channel:VARCHAR# ]]>
  		</isNotEmpty>  
		 <isNotEmpty prepend="AND" property="startdate" >
           <![CDATA[ appodate >= #startdate:VARCHAR# ]]>
  		</isNotEmpty>
  		<isNotEmpty prepend="AND" property="enddate" >
  			<![CDATA[ appodate <= #enddate:VARCHAR# ]]>
  		</isNotEmpty>
  		<isNotEmpty prepend="AND" property="appobranchid" >
  			<![CDATA[ appobranchid in (select appobranchid from mi623,mi201 where mi623.website_code = mi201.website_code and area_id = #appobranchid:VARCHAR#) ]]>
  		</isNotEmpty>
  		order by a.DATECREATED,appoid asc
  </select>
</sqlMap>